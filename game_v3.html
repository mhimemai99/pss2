<!doctype html>
<!-- Pathways v1.1 — Purpose & Happiness (HK Uni Edition)
     Adds readiness-gated mechanics:
     - Dynamic difficulty from meters (−2/−1/+1/+2)
     - SAFE → RISK when relevant meter very low
     - LOCKED choices at critical depletion
     - AUTO success when highly prepared
     - Debrief records status notes and modifiers
-->
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pathways v1.1 — Purpose & Happiness (HK Uni Edition)</title>
<style>
  :root{
    --bg:#0b0c10;
    --panel:#12141a;
    --ink:#e9ecf1;
    --muted:#aab3c2;
    --jade:#14b8a6;
    --amber:#ffb020;
    --accent:#7c8cff;
    --danger:#ff6b6b;
    --good:#2ecc71;
    --mid:#f0f3f9;
    --card:#171a22;
    --btn:#1f2330;
    --btnh:#2a3042;
    --grid-gap:14px;
    --br:14px;
    --shadow:0 4px 18px rgba(0,0,0,.35);
    --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue",
            "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", Arial, "PingFang SC","Microsoft YaHei","Heiti SC","Helvetica", sans-serif;
  }
  * { box-sizing: border-box; }
  html, body { background:var(--bg); color:var(--ink); margin:0; font-family:var(--font); }
  .wrap { padding:16px; max-width:1200px; margin:0 auto; }
  header.app {
    display:flex; align-items:center; gap:12px; flex-wrap:wrap;
    padding:10px 0 6px 0; border-bottom:1px solid #212633;
  }
  header.app h1 { font-size:20px; margin:0 8px 0 0; letter-spacing:.2px; }
  .pill { border:1px solid #273046; border-radius:999px; padding:6px 10px; font-size:13px; color:var(--muted); }
  .tag { background:#1f2432; color:#b9c3d9; border-radius:999px; padding:4px 10px; font-size:12px; border:1px solid #2b344a; }
  .grid { display:grid; grid-template-columns: 1.3fr .9fr; gap:var(--grid-gap); margin-top:16px; }
  .card { background:var(--card); border:1px solid #23283a; border-radius:var(--br); box-shadow:var(--shadow); }
  .card .hd { padding:14px 16px; border-bottom:1px solid #22293a; display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .card .bd { padding:16px; }
  .scenario-title { font-size:18px; margin:0; letter-spacing:.2px; }
  .scenario-desc { color:var(--muted); margin:6px 0 0 0; line-height:1.5; font-size:15px; }
  .choices { display:flex; flex-direction:column; gap:10px; margin-top:14px; }
  button.choice {
    text-align:left; background:var(--btn); border:1px solid #2a3248; padding:12px 14px; border-radius:12px;
    color:var(--ink); cursor:pointer; transition:.15s transform, .15s background;
  }
  button.choice:hover { background:var(--btnh); transform: translateY(-1px); }
  .choice .row { display:flex; align-items:center; gap:10px; justify-content:space-between; }
  .choice .meta { display:flex; align-items:center; gap:6px; color:var(--muted); font-size:12px; }
  .difficulty { font-weight:600; letter-spacing:.2px; }
  .safe { color:#c7e7ff; }
  .challenge { color:#ffd18e; }
  .panel-muted { background:#0f131c; border:1px dashed #2b344a; border-radius:12px; padding:12px; color:#b8c2d6; }
  .right { display:flex; flex-direction:column; gap:var(--grid-gap); }
  .team-card { padding:0; }
  .team-hd { display:flex; align-items:center; justify-content:space-between; }
  .team-name { font-weight:700; font-size:16px; letter-spacing:.3px; }
  .team-Jade .team-name { color:var(--jade); }
  .team-Amber .team-name { color:var(--amber); }
  .meters { display:grid; grid-template-columns:1fr; gap:10px; margin-top:12px; }
  .meter { display:grid; grid-template-columns:120px 1fr 54px; gap:8px; align-items:center; }
  .meter label { font-size:13px; color:#cfd6e6; }
  .bar { height:12px; background:#1b2233; border-radius:999px; position:relative; overflow:hidden; border:1px solid #2b344a; }
  .fill { position:absolute; inset:0 100% 0 0; background:linear-gradient(90deg, #7fd6ff, #8be7c5); border-right:1px solid rgba(255,255,255,.25); }
  .val { font-size:12px; color:#b6c0d6; text-align:right; }
  .coins { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
  .coin { border:1px solid #34405a; background:#171e2c; padding:6px 10px; border-radius:999px; font-size:12px; color:#cbd6ea; }
  .coin b { color:#fff; }
  .toolbar { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .toolbar button, .hd button, .plain-btn {
    background:#1f2536; color:#e9eef8; border:1px solid #2b344a; border-radius:10px; padding:8px 12px; cursor:pointer;
  }
  .toolbar button:hover, .hd button:hover, .plain-btn:hover { background:#2b3146; }
  .muted { color:var(--muted); }
  .small { font-size:12px; }
  .active-team { display:inline-flex; align-items:center; gap:8px; }
  .dot { width:10px; height:10px; border-radius:999px; display:inline-block; }
  .dot.jade { background:var(--jade); }
  .dot.amber { background:var(--amber); }
  .kbd { font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; padding:2px 6px; border:1px solid #2b344a; background:#1a1f2e; border-radius:6px; color:#d7def0; font-size:12px; }
  .footer { margin-top:16px; color:var(--muted); font-size:12px; text-align:center; }
  /* setup dialog */
  .setup { display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
  .setup .field { display:flex; flex-direction:column; gap:6px; }
  .setup input[type="text"], .setup select {
    background:#121827; color:#e4ebff; border:1px solid #2a3248; border-radius:10px; padding:10px;
  }
  .setup .toggle { display:flex; align-items:center; gap:8px; margin-top:2px; }
  /* modal */
  dialog {
    border:none; border-radius:16px; background:#101524; color:#eef2ff; padding:0; width:min(680px, calc(100vw - 24px));
    box-shadow: 0 25px 60px rgba(0,0,0,.6), 0 0 0 1px #24304d inset;
  }
  dialog::backdrop { background: rgba(0,0,0,.55); backdrop-filter: blur(4px); }
  .modal-hd { padding:14px 16px; border-bottom:1px solid #222b40; display:flex; align-items:center; justify-content:space-between; }
  .modal-bd { padding:16px; }
  .dice { font-size:40px; line-height:1; display:inline-block; padding:12px 16px; border-radius:12px; background:#161d2e; border:1px solid #2a3450; }
  .result { font-size:16px; margin-top:8px; }
  .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .grow { flex:1; }
  .callout { background:#111a2b; border:1px solid #26324e; border-radius:12px; padding:12px; }
  .success { color:#8ef0c1; }
  .fail { color:#ffb3b3; }
  .danger { color:var(--danger); }
  .good { color:var(--good); }
  .hr { height:1px; background:#24304c; margin:14px 0; }
  .list { display:flex; flex-direction:column; gap:8px; }
  /* debrief */
  .debrief .cols { display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
  .debrief h3 { margin:0 0 8px 0; }
  .alt { color:#cfe0ff; font-size:13px; }
  .kbdrow { display:flex; align-items:center; gap:8px; justify-content:flex-end; }
  /* responsive */
  @media (max-width:980px){ .grid{ grid-template-columns:1fr; } .right{ order:-1;} }
</style>
</head>
<body>
<div class="wrap">
  <header class="app" aria-live="polite">
    <h1>Pathways — Purpose & Happiness (HK Uni Edition) <span class="muted small">v1.1</span></h1>
    <span class="pill">Text-first • Dice-based • Two teams</span>
    <span class="pill">Maslow + Lyubomirsky • Readiness‑gated</span>
    <span id="timer" class="pill">00:00</span>
    <span id="roundInfo" class="pill">Round —</span>
    <span id="activeTeamPill" class="pill active-team">
      <span class="dot jade" id="activeTeamDot"></span><span id="activeTeamName">—</span>
    </span>
    <div class="toolbar">
      <button id="switchBtn" title="Alternate to the other team"><span class="small">Switch team</span></button>
      <button id="restartBtn" title="Restart the session"><span class="small">Restart</span></button>
      <button id="openGuideBtn" class="small">Facilitator guide</button>
    </div>
  </header>

  <div class="grid">
    <section id="scenarioCard" class="card">
      <div class="hd">
        <div>
          <div class="tag" id="scenarioTag">Scenario</div>
          <h2 class="scenario-title" id="scenarioTitle">Welcome</h2>
        </div>
        <div class="kbdrow">
          <span class="kbd" title="Gratitude token count">G</span>
          <span class="kbd" title="Mindful Pause token count">M</span>
          <span class="kbd" title="Social Support reroll tokens">S</span>
        </div>
      </div>
      <div class="bd">
        <p class="scenario-desc" id="scenarioDesc">
          Click “Start” in the setup below to begin. Teams alternate turns by default so the whole game fits in 30–40 minutes.
        </p>

        <div id="choices" class="choices" aria-live="polite"></div>

        <div id="preGame" class="panel-muted" style="margin-top:14px;">
          <div class="setup">
            <div class="field">
              <label>Team A name</label>
              <input type="text" id="teamAName" value="Team Jade" />
            </div>
            <div class="field">
              <label>Team B name</label>
              <input type="text" id="teamBName" value="Team Amber" />
            </div>
            <div class="field">
              <label>Number of scenarios (6–10)</label>
              <select id="scenarioCount">
                <option value="6">6 (≈25–30 min)</option>
                <option value="8" selected>8 (≈30–40 min)</option>
                <option value="10">10 (≈40–50 min)</option>
              </select>
            </div>
            <div class="field">
              <label>Overall difficulty</label>
              <select id="overallDifficulty">
                <option value="-1">Gentle</option>
                <option value="0" selected>Balanced</option>
                <option value="1">Challenging</option>
              </select>
            </div>
            <div class="field">
              <label>Run style</label>
              <div class="toggle">
                <input type="checkbox" id="doubleRun" />
                <label for="doubleRun" class="small">Double‑run mode (both teams attempt every scenario)</label>
              </div>
            </div>
            <div class="field">
              <button id="startBtn"><b>Start session</b></button>
            </div>
          </div>
          <p class="small muted" style="margin-top:8px;">
            Tip: Press <span class="kbd">?</span> during play to see the facilitator guide. Press <span class="kbd">R</span> to reroll when a Social Support token is available.
          </p>
        </div>
      </div>
    </section>

    <aside class="right">
      <section id="teamA" class="card team-card team-Jade" aria-live="polite">
        <div class="hd team-hd">
          <span class="team-name" id="teamAHeader">Team Jade</span>
          <div class="coins" id="teamATokens"></div>
        </div>
        <div class="bd">
          <div class="meters" id="teamAMeters"></div>
        </div>
      </section>

      <section id="teamB" class="card team-card team-Amber" aria-live="polite">
        <div class="hd team-hd">
          <span class="team-name" id="teamBHeader">Team Amber</span>
          <div class="coins" id="teamBTokens"></div>
        </div>
        <div class="bd">
          <div class="meters" id="teamBMeters"></div>
        </div>
      </section>

      <section class="card">
        <div class="hd">
          <div>
            <div class="tag">Why this game?</div>
            <h3 style="margin:6px 0 0 0;">Maslow + Happiness Habits + Readiness</h3>
          </div>
        </div>
        <div class="bd small">
          <p>
            Your choices influence six sliders: <b>Vitality</b> (sleep/health), <b>Security</b> (safety & finances),
            <b>Connection</b> (belonging), <b>Mastery</b> (competence/esteem), <b>Purpose</b> (meaning/values),
            and <b>Joy</b> (moments of pleasure).
          </p>
          <p>
            From v1.1, these meters <i>change access & odds</i>: high readiness eases challenges or auto‑succeeds;
            low readiness can lock options or turn safe choices risky. Boosts (Gratitude, Mindful Pause, Social Support)
            still tilt chance in the moment.
          </p>
        </div>
      </section>
    </aside>
  </div>

  <div class="footer small">
    Built as a single‑file classroom activity. No data leaves your browser. Refresh to reset.
  </div>
</div>

<!-- Challenge Modal -->
<dialog id="challengeModal" aria-label="Challenge outcome">
  <div class="modal-hd">
    <strong id="challengeTitle">Challenge</strong>
    <button id="closeModal" class="plain-btn">Close</button>
  </div>
  <div class="modal-bd">
    <div class="row">
      <div class="grow">
        <div class="small muted">Difficulty (success on):</div>
        <div class="row" style="align-items:baseline;">
          <div class="kbd" id="difficultyKbd">4+</div>
          <div class="small muted">Approx. chance shown before boosts.</div>
        </div>
      </div>
      <div>
        <div class="small muted">Die</div>
        <div class="dice" id="die">—</div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <div class="callout grow">
        <div class="small muted" style="margin-bottom:6px;">Optional Happiness Habit boosts</div>
        <div class="row">
          <button class="plain-btn small" id="useG">Use Gratitude (+1)</button>
          <button class="plain-btn small" id="useM">Use Mindful Pause (+1)</button>
          <button class="plain-btn small" id="useS">Use Social Support (reroll)</button>
        </div>
      </div>
      <div>
        <button id="rollBtn"><b>Roll</b></button>
      </div>
    </div>

    <div id="resultBox" class="result" aria-live="polite"></div>
    <div id="randomEventBox" class="small muted" style="margin-top:8px;"></div>

    <div class="hr"></div>
    <div class="row">
      <button id="applyOutcomeBtn" disabled>Apply outcome</button>
      <button id="cancelOutcomeBtn" class="plain-btn">Cancel</button>
    </div>
  </div>
</dialog>

<!-- Debrief Modal -->
<dialog id="debriefModal" class="debrief" aria-label="Session debrief">
  <div class="modal-hd">
    <strong>Debrief & Discussion</strong>
    <button id="closeDebrief" class="plain-btn">Close</button>
  </div>
  <div class="modal-bd">
    <p class="small">
      Below are each team’s key moments, dice outcomes, and plausible alternatives. Use these prompts to connect <b>momentary joy</b> with <b>purpose</b> and
      Maslow’s foundations. Buttons at the bottom let you download/print this summary.
    </p>
    <div class="cols">
      <div>
        <h3 id="debAName">Team A</h3>
        <div id="debA"></div>
      </div>
      <div>
        <h3 id="debBName">Team B</h3>
        <div id="debB"></div>
      </div>
    </div>
    <div class="hr"></div>
    <div class="small">
      <b>Facilitator prompts:</b>
      <ul>
        <li>Which choices boosted <i>Connection</i> or <i>Purpose</i> without sacrificing <i>Vitality</i>?</li>
        <li>Where did a short‑term <i>Joy</i> choice help or hurt in the long run?</li>
        <li>How did Gratitude / Mindful Pause / Social Support boosts change risk decisions?</li>
        <li>Which happiness habits would you carry into next week?</li>
      </ul>
    </div>
    <div class="row" style="margin-top:10px;">
      <button id="downloadDebrief">Download debrief (HTML)</button>
      <button id="printDebrief" class="plain-btn">Print</button>
    </div>
  </div>
</dialog>

<!-- Guide Modal -->
<dialog id="guideModal" aria-label="Facilitator guide">
  <div class="modal-hd">
    <strong>Facilitator Guide</strong>
    <button id="closeGuideBtn" class="plain-btn">Close</button>
  </div>
  <div class="modal-bd small">
    <p><b>Suggested 50‑minute flow</b> — 3 min setup · 30–40 min play · 8–12 min debrief.</p>
    <ol>
      <li><b>Split class into two teams.</b> Set names. Choose 6–10 scenarios. Explain boosts and dice.</li>
      <li><b>Alternate turns</b> (default). Encourage the non‑active team to advise briefly (≤30s).</li>
      <li><b>Call out the meters</b> for trade‑offs (Vitality/Security/Connection/Mastery/Purpose/Joy).</li>
      <li><b>Spend boosts</b> only when it matters; invite teams to justify via happiness habits.</li>
      <li><b>Debrief</b>: Use the auto summary. Ask “what else could you have done?” (alternatives shown).</li>
    </ol>
    <p><b>Tokens & habits</b> — Gratitude (+1 and +Joy), Mindful Pause (+1 and +Vitality), Social Support (1 reroll).
       Teams can <i>earn</i> extra tokens when taking kindness/relationship/health/goal/optimism‑aligned options.</p>
    <p><b>Readiness (v1.1)</b> — High meters ease odds or auto‑succeed; low meters can lock or riskify choices.
       This teaches preparation, pacing, and resourcing.</p>
  </div>
</dialog>

<script>
/* ===========
   Data Model
   =========== */

const METERS = [
  {key:'vitality', label:'Vitality (sleep/health)'},
  {key:'security', label:'Security (safety/finances)'},
  {key:'connection', label:'Connection (belonging)'},
  {key:'mastery', label:'Mastery (competence/esteem)'},
  {key:'purpose', label:'Purpose (values/meaning)'},
  {key:'joy', label:'Joy (pleasure/positive emotion)'},
];

const TOKEN_LABELS = { G:'Gratitude +1', M:'Mindful Pause +1', S:'Social Support (reroll)' };
const BASE_START = { vitality:60, security:55, connection:55, mastery:55, purpose:50, joy:55 };

/* ===========
   Scenarios (with some prerequisites / autosuccess)
   =========== */

const SCENARIOS = [
  {
    id:'s1',
    title:'O‑Week crossroads',
    prompt:'It’s Orientation Week at your HK university. You’re torn between running for a student society committee, focusing fully on lectures, or taking a part‑time job to support family.',
    key:true,
    choices:[
      {
        id:'join_soc',
        label:'Run for society committee (big time commitment)',
        type:'challenge', difficulty:4,
        requires:{ connection:30 },
        success:{ connection:+20, mastery:+5, purpose:+10, vitality:-5, joy:+5 },
        fail:{ connection:+12, mastery:+2, purpose:+4, vitality:-10, joy:-2 },
        approx:'Build belonging and leadership; risk fatigue.',
        tags:['relationships','goal','leadership']
      },
      {
        id:'focus_study',
        label:'Focus on lectures and routines this term',
        type:'safe',
        effects:{ mastery:+12, vitality:+5, joy:-2, connection:-6 },
        approx:'Stable gains, slower social roots.',
        tags:['goal','flow']
      },
      {
        id:'part_time',
        label:'Take a part‑time job for family support',
        type:'challenge', difficulty:5,
        requires:{ vitality:25 },
        success:{ security:+18, mastery:+4, vitality:-6, joy:+2, purpose:+5 },
        fail:{ security:+8, vitality:-10, mastery:-2, joy:-3 },
        approx:'Financial buffer; heavier load.',
        tags:['security','coping','family']
      }
    ]
  },
  {
    id:'s2',
    title:'Midterm crunch & a friend in need',
    prompt:'Midterms approach. A hall mate struggling with DSE‑to‑uni transition asks for help.',
    key:true,
    choices:[
      {
        id:'tutor_friend',
        label:'Offer to tutor + organise a 1‑hour study group',
        type:'challenge', difficulty:3,
        requires:{ mastery:30 },
        success:{ connection:+14, purpose:+8, mastery:+6, joy:+3 },
        fail:{ connection:+8, mastery:+2, vitality:-5 },
        approx:'Kindness & relationships; small time cost.',
        tags:['kindness','relationships']
      },
      {
        id:'say_no',
        label:'Say no this time; focus on your own revision plan',
        type:'safe',
        effects:{ mastery:+10, vitality:+2, connection:-5 },
        approx:'Protects focus, less social capital.',
        tags:['goal']
      },
      {
        id:'share_notes',
        label:'Share notes but keep boundaries clear',
        type:'challenge', difficulty:2,
        success:{ connection:+8, mastery:+4, purpose:+3 },
        fail:{ connection:+3, mastery:+1, joy:-1 },
        approx:'Low‑risk help; boundary‑setting practice.',
        tags:['relationships','coping']
      }
    ]
  },
  {
    id:'s3',
    title:'The internship fork',
    prompt:'Summer is near. Options: Big‑4/tech internship, NGO service project in Sham Shui Po, or research assistantship with a professor.',
    key:true,
    choices:[
      {
        id:'big4',
        label:'Apply to a prestige Big‑4/tech internship',
        type:'challenge', difficulty:5,
        requires:{ mastery:45 }, autoSuccessIf:{ mastery:88 },
        success:{ mastery:+12, security:+12, purpose:+4, vitality:-5 },
        fail:{ mastery:+3, joy:-3, purpose:-2 },
        approx:'Career boost; competitive and stressful.',
        tags:['goal','optimism']
      },
      {
        id:'ngo_service',
        label:'Commit to an NGO service project (Sham Shui Po)',
        type:'challenge', difficulty:3,
        success:{ purpose:+14, connection:+10, joy:+4, mastery:+4 },
        fail:{ purpose:+6, connection:+4, vitality:-4 },
        approx:'Meaning/connection; lighter on CV signalling.',
        tags:['kindness','relationships','purpose']
      },
      {
        id:'research_ra',
        label:'Work as a research assistant (flexible)',
        type:'safe',
        effects:{ mastery:+10, purpose:+6, security:+4 },
        approx:'Build competence and mentoring ties.',
        tags:['flow','goal','relationships']
      }
    ]
  },
  {
    id:'s4',
    title:'Family talk: passion vs expectation',
    prompt:'Your parents prefer an accounting major. You want to minor in creative media. Have the conversation now?',
    key:true,
    choices:[
      {
        id:'open_talk',
        label:'Plan a respectful conversation this weekend',
        type:'challenge', difficulty:4,
        requires:{ connection:30 },
        success:{ purpose:+10, connection:+6, security:+2, mastery:+3 },
        fail:{ purpose:+4, connection:-2, joy:-2 },
        approx:'Values alignment; emotionally taxing.',
        tags:['forgiveness','relationships','optimism']
      },
      {
        id:'avoid',
        label:'Avoid for now; keep minor private',
        type:'safe',
        effects:{ joy:+3, purpose:-4, connection:-3 },
        approx:'Short‑term peace, long‑term friction.',
        tags:['coping']
      },
      {
        id:'mentor_help',
        label:'Seek a mentor/alumni to mediate',
        type:'challenge', difficulty:3,
        success:{ connection:+8, purpose:+8, mastery:+3 },
        fail:{ connection:+3, joy:-1 },
        approx:'Social support for tough talks.',
        tags:['relationships','kindness']
      }
    ]
  },
  {
    id:'s5',
    title:'Money & phone temptation',
    prompt:'Your phone is lagging. Do you buy the latest model or keep a budget and apply for a bursary?',
    key:false,
    choices:[
      {
        id:'buy_phone',
        label:'Buy new phone (12‑month plan)',
        type:'safe',
        effects:{ joy:+8, security:-10, purpose:-2 },
        approx:'Immediate joy; lower financial buffer.',
        tags:['joy']
      },
      {
        id:'budget_bursary',
        label:'Budget strictly + apply for bursary',
        type:'challenge', difficulty:4,
        requires:{ mastery:25 },
        success:{ security:+14, mastery:+5, purpose:+5, joy:+2 },
        fail:{ security:+7, vitality:-3, joy:-1 },
        approx:'Paperwork & patience; long‑term stability.',
        tags:['coping','goal']
      },
      {
        id:'second_hand',
        label:'Find a reliable second‑hand phone',
        type:'safe',
        effects:{ joy:+4, security:-3, mastery:+2 },
        approx:'Moderate joy with less cost.',
        tags:['goal']
      }
    ]
  },
  {
    id:'s6',
    title:'Sleep, study, and steps',
    prompt:'Project week. You can pull all‑nighters, or protect sleep and move your body daily.',
    key:false,
    choices:[
      {
        id:'allnighter',
        label:'All‑nighters for 3 days',
        type:'safe',
        effects:{ mastery:+6, vitality:-14, joy:-3, purpose:-2 },
        approx:'Short‑term output, big Vitality hit.',
        tags:['goal']
      },
      {
        id:'sleep_exercise',
        label:'8‑hour sleep + 20‑min walk daily',
        type:'challenge', difficulty:3,
        success:{ vitality:+14, joy:+6, mastery:+5 },
        fail:{ vitality:+6, joy:+3, mastery:+2 },
        approx:'Body care habit; compounds benefits.',
        tags:['exercise','mindful']
      },
      {
        id:'study_group',
        label:'Structured study group (90 mins/day)',
        type:'challenge', difficulty:3,
        success:{ mastery:+8, connection:+6, joy:+3 },
        fail:{ mastery:+4, connection:+3, vitality:-2 },
        approx:'Flow & belonging; mild time trade‑off.',
        tags:['relationships','flow']
      }
    ]
  },
  {
    id:'s7',
    title:'Integrity check',
    prompt:'A senior offers last year’s graded assignment. You feel uneasy.',
    key:true,
    choices:[
      {
        id:'decline_report',
        label:'Decline and explain why; report if needed',
        type:'challenge', difficulty:4,
        requires:{ purpose:35 },
        success:{ purpose:+12, mastery:+6, connection:+3, joy:+1 },
        fail:{ purpose:+6, connection:-2, joy:-2 },
        approx:'Values in action; social risk.',
        tags:['purpose','optimism']
      },
      {
        id:'quiet_decline',
        label:'Quietly decline and move on',
        type:'safe',
        effects:{ purpose:+4, joy:-1 },
        approx:'Protects integrity; avoids confrontation.',
        tags:['coping']
      },
      {
        id:'accept_copy',
        label:'Accept it “just to reference”',
        type:'safe',
        effects:{ mastery:+2, purpose:-12, security:-4 },
        approx:'Short‑term ease, long‑term risk.',
        tags:['joy']
      }
    ]
  },
  {
    id:'s8',
    title:'Capstone conflict',
    prompt:'Your capstone team is stuck. Two members stopped showing up. Do you mediate, escalate, or ignore?',
    key:true,
    choices:[
      {
        id:'mediate',
        label:'Facilitate a mediation meeting',
        type:'challenge', difficulty:4,
        requires:{ connection:35 },
        success:{ connection:+10, mastery:+6, purpose:+8, joy:+2 },
        fail:{ connection:+4, vitality:-4 },
        approx:'Relational skill; emotionally demanding.',
        tags:['relationships','kindness','coping']
      },
      {
        id:'escalate',
        label:'Escalate to supervisor with evidence',
        type:'challenge', difficulty:3,
        success:{ mastery:+8, security:+4, purpose:+5 },
        fail:{ mastery:+3, connection:-3 },
        approx:'Protection and structure; reputation risk.',
        tags:['goal','optimism']
      },
      {
        id:'ignore',
        label:'Do your part; ignore the conflict',
        type:'safe',
        effects:{ mastery:+4, connection:-6, vitality:-2 },
        approx:'Less drama; poorer team climate.',
        tags:['coping']
      }
    ]
  },
  {
    id:'s9',
    title:'Community weekend',
    prompt:'Weekend plans clash: service day in Sham Shui Po, hike to Dragon’s Back, or just Netflix?',
    key:false,
    choices:[
      {
        id:'service',
        label:'Join service day (elderly outreach)',
        type:'challenge', difficulty:2,
        success:{ purpose:+10, connection:+8, joy:+4 },
        fail:{ purpose:+5, connection:+4, vitality:-2 },
        approx:'Meaningful contact, modest effort.',
        tags:['kindness','relationships','savor']
      },
      {
        id:'hike',
        label:'Hike Dragon’s Back with friends',
        type:'safe',
        effects:{ vitality:+6, joy:+6, connection:+4 },
        approx:'Joy + body care + bonding.',
        tags:['exercise','savor']
      },
      {
        id:'netflix',
        label:'Netflix recharge day',
        type:'safe',
        effects:{ joy:+6, vitality:+2, purpose:-3 },
        approx:'Rest now, less meaning/connection.',
        tags:['joy','coping']
      }
    ]
  },
  {
    id:'s10',
    title:'Offer in hand',
    prompt:'You get two offers: a high‑paying corporate role with long hours; a lower‑pay purpose‑driven role with growth.',
    key:true,
    choices:[
      {
        id:'high_pay',
        label:'Take high‑pay role; negotiate for learning time',
        type:'challenge', difficulty:5,
        requires:{ mastery:50 },
        success:{ security:+16, mastery:+8, vitality:-6, purpose:+4 },
        fail:{ security:+10, vitality:-8, joy:-2 },
        approx:'Financial runway; risk of burnout.',
        tags:['goal','optimism']
      },
      {
        id:'purpose_role',
        label:'Take purposeful role; build portfolio',
        type:'challenge', difficulty:4,
        requires:{ purpose:40 },
        success:{ purpose:+14, mastery:+8, connection:+6, security:+4 },
        fail:{ purpose:+8, mastery:+4, security:+2 },
        approx:'Meaning and growth; lower pay.',
        tags:['purpose','flow']
      },
      {
        id:'defer',
        label:'Defer both; pursue skills for one term',
        type:'safe',
        effects:{ mastery:+10, purpose:+4, security:-6 },
        approx:'Invest in capabilities; delayed income.',
        tags:['goal','flow']
      }
    ]
  }
];

/* ===========
   State
   =========== */

const app = {
  started:false,
  schedule:[], // array of {scenarioId, team: 'A'|'B'}
  index:-1,
  startTime:null,
  timerInt:null,
  baseDiffOffset:0,
  doubleRun:false,
  activeTeam:'A',
  teams:{
    A: { name:'Team Jade',  meters:{...BASE_START}, tokens:{G:1, M:1, S:1}, history:[] },
    B: { name:'Team Amber', meters:{...BASE_START}, tokens:{G:1, M:1, S:1}, history:[] }
  }
};

/* ===========
   Utilities
   =========== */

function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
function deepCopy(obj){ return JSON.parse(JSON.stringify(obj)); }
function byId(id){ return document.getElementById(id); }
function formatMinSec(ms){
  const s = Math.floor(ms/1000); const m = Math.floor(s/60); const r = s%60;
  return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;
}
function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
function approxChance(threshold){ return clamp((7-threshold)/6, 0, 1); }
function meterColor(val){
  if(val>=75) return 'linear-gradient(90deg,#7fe7c5,#8ed6ff)';
  if(val>=50) return 'linear-gradient(90deg,#9fd1ff,#c8f7d2)';
  if(val>=30) return 'linear-gradient(90deg,#ffd18e,#ffdca6)';
  return 'linear-gradient(90deg,#ff9a9a,#ffb3b3)';
}

/* ===========
   Readiness rules (NEW in v1.1)
   =========== */

const TAG_TO_METERS = {
  exercise:['vitality'], mindful:['vitality'], coping:['vitality'],
  security:['security'], budget:['security'],
  relationships:['connection'], kindness:['connection'], family:['connection'],
  goal:['mastery'], flow:['mastery'], leadership:['mastery'],
  purpose:['purpose'], spiritual:['purpose'], optimism:['purpose'],
  joy:['joy'], savor:['joy']
};

const READINESS_RULES = Object.freeze({
  high2: 85,  // ≥85 → −2
  high1: 70,  // ≥70 → −1
  low1:  35,  // ≤35 → +1
  low2:  20,  // ≤20 → +2
  lockBelow: 12,   // ≤12 → LOCK certain challenge choices
  safeRiskBase: 4, // SAFE → CHALLENGE base threshold when very low
});

const cap = s => s.charAt(0).toUpperCase()+s.slice(1);

function metersForChoice(choice){
  const set = new Set();
  (choice.tags||[]).forEach(t => (TAG_TO_METERS[t]||[]).forEach(m => set.add(m)));
  if(set.size===0) set.add('purpose'); // fallback
  return [...set];
}

function computeChoiceDynamics(choice, teamKey){
  const team = app.teams[teamKey];
  const relevant = metersForChoice(choice);
  const mods = [];
  const lows = [];
  const highs = [];

  const reqs = choice.requires || null;
  const autos = choice.autoSuccessIf || null;

  if(reqs){
    for(const [k,min] of Object.entries(reqs)){
      if((team.meters[k]||0) < min){
        return { status:'locked', threshold:null, mods:[], reason:`Requires ${cap(k)} ≥ ${min}`, relevant };
      }
    }
  }

  relevant.forEach(key=>{
    const v = team.meters[key] ?? 50;
    if(v >= READINESS_RULES.high2){ mods.push({key, delta:-2, why:`${cap(key)} high (≥${READINESS_RULES.high2})`}); highs.push(key); }
    else if(v >= READINESS_RULES.high1){ mods.push({key, delta:-1, why:`${cap(key)} good (≥${READINESS_RULES.high1})`}); }
    else if(v <= READINESS_RULES.low2){ mods.push({key, delta:+2, why:`${cap(key)} very low (≤${READINESS_RULES.low2})`}); lows.push(key); }
    else if(v <= READINESS_RULES.low1){ mods.push({key, delta:+1, why:`${cap(key)} low (≤${READINESS_RULES.low1})`}); }
  });

  if(choice.type==='challenge'){
    const base = clamp((choice.difficulty||4) + app.baseDiffOffset, 2, 6);
    const adjusted = clamp(base + mods.reduce((a,m)=>a+m.delta,0), 2, 6);

    if(lows.some(k => (team.meters[k]||0) <= READINESS_RULES.lockBelow)){
      return { status:'locked', threshold:null, mods, reason:`Locked: ${cap(lows[0])} too low (≤${READINESS_RULES.lockBelow})`, relevant };
    }

    if(autos){
      for(const [k,min] of Object.entries(autos)){
        if((team.meters[k]||0) >= min){
          return { status:'auto', threshold:adjusted, mods, reason:`Auto ✓: ${cap(k)} ≥ ${min}`, relevant };
        }
      }
    }
    if(highs.length && adjusted <= 3){
      return { status:'auto', threshold:adjusted, mods, reason:`Auto ✓: high ${cap(highs[0])}`, relevant };
    }
    return { status:'normal', threshold:adjusted, mods, reason:'', relevant };
  }

  if(choice.type==='safe'){
    if(lows.length){
      const thr = clamp(READINESS_RULES.safeRiskBase + app.baseDiffOffset + (lows.length>0?1:0), 2, 6);
      return { status:'risk', threshold:thr, mods, reason:`Becomes challenge: low ${cap(lows[0])}`, relevant };
    }
    return { status:'normal', threshold:null, mods, reason:'', relevant };
  }

  return { status:'normal', threshold:null, mods, reason:'', relevant };
}

function riskifyChoice(choice, threshold){
  const success = {...(choice.effects||{})};
  const fail = invertEffectsForRisk(success);
  return {
    id: choice.id + '_risk',
    label: choice.label + ' (risk due to low readiness)',
    type: 'challenge',
    difficulty: threshold,
    success, fail,
    approx: (choice.approx||'') + ' (readiness low)',
    tags: choice.tags||[]
  };
}

function invertEffectsForRisk(effects){
  const out = {};
  for(const [k,v] of Object.entries(effects||{})){
    if(v >= 0) out[k] = -Math.max(2, Math.round(v*0.6));
    else out[k] = v - 2;
  }
  out.vitality = (out.vitality||0) - 2;
  return out;
}

/* ===========
   Rendering
   =========== */

function renderMeters(teamKey){
  const team = app.teams[teamKey];
  const container = byId(teamKey==='A'?'teamAMeters':'teamBMeters');
  container.innerHTML = '';
  METERS.forEach(m=>{
    const val = clamp(Math.round(team.meters[m.key]),0,100);
    const row = document.createElement('div'); row.className='meter';
    const lab = document.createElement('label'); lab.textContent = m.label;
    const bar = document.createElement('div'); bar.className='bar';
    const fill = document.createElement('div'); fill.className='fill'; fill.style.width = val+'%'; fill.style.background = meterColor(val);
    bar.appendChild(fill);
    const num = document.createElement('div'); num.className='val'; num.textContent = val;
    row.append(lab,bar,num);
    container.appendChild(row);
  });
  const tContainer = byId(teamKey==='A'?'teamATokens':'teamBTokens');
  const t = team.tokens;
  tContainer.innerHTML = '';
  tContainer.innerHTML = [
    `<span class="coin">G: <b>${t.G||0}</b></span>`,
    `<span class="coin">M: <b>${t.M||0}</b></span>`,
    `<span class="coin">S: <b>${t.S||0}</b></span>`
  ].join('');
  if(teamKey==='A'){ byId('teamAHeader').textContent = team.name; } else { byId('teamBHeader').textContent = team.name; }
}

function renderAll(){
  renderMeters('A'); renderMeters('B');
  byId('activeTeamName').textContent = app.activeTeam==='A'?app.teams.A.name:app.teams.B.name;
  const dot = byId('activeTeamDot');
  dot.className = 'dot ' + (app.activeTeam==='A'?'jade':'amber');
}

function getScenarioById(id){ return SCENARIOS.find(s=>s.id===id); }

function renderScenarioCard(){
  const scd = app.schedule[app.index];
  if(!scd){ return; }
  const scen = getScenarioById(scd.scenarioId);
  const teamKey = scd.team;
  app.activeTeam = teamKey;

  byId('scenarioTag').textContent = `Scenario ${app.index+1} of ${app.schedule.length}`;
  byId('scenarioTitle').textContent = scen.title;
  byId('scenarioDesc').textContent = scen.prompt;

  const choicesDiv = byId('choices');
  choicesDiv.innerHTML = '';

  scen.choices.forEach(ch=>{
    const dyn = computeChoiceDynamics(ch, teamKey);
    const btn = document.createElement('button');
    btn.className = 'choice';
    btn.dataset.choiceId = ch.id;

    let metaStr = '';
    if(ch.type==='safe'){
      if(dyn.status==='risk'){
        const pct = Math.round(approxChance(dyn.threshold)*100);
        metaStr = `<span class="meta"><span class="challenge">CHALLENGE</span> · due to low readiness · needs ${dyn.threshold}+ · ~${pct}%</span>`;
      } else {
        metaStr = `<span class="meta"><span class="safe">SAFE</span> · ${ch.approx||''}</span>`;
      }
    } else {
      if(dyn.status==='locked'){
        metaStr = `<span class="meta"><span class="danger">LOCKED</span> · ${dyn.reason}</span>`;
      } else if(dyn.status==='auto'){
        metaStr = `<span class="meta"><span class="good">AUTO ✓</span> · ${dyn.reason}</span>`;
      } else {
        const pct = Math.round(approxChance(dyn.threshold)*100);
        const modsTxt = dyn.mods.length
          ? ' · mods: ' + dyn.mods.map(m => (m.delta>0?'+':'')+m.delta+' '+m.key).join(', ')
          : '';
        metaStr = `<span class="meta"><span class="challenge">CHALLENGE</span> · needs ${dyn.threshold}+ · ~${pct}%${modsTxt}</span>`;
      }
    }

    btn.innerHTML = `
      <div class="row">
        <div>${ch.label}</div>
        <div>${metaStr}</div>
      </div>
    `;

    if(ch.type==='challenge' && dyn.status==='locked'){
      btn.disabled = true;
      btn.title = dyn.reason || 'Locked';
    }

    btn.addEventListener('click', ()=>{
      onChoiceSelected(scen, ch, teamKey, dyn);
    });

    choicesDiv.appendChild(btn);
  });

  byId('roundInfo').textContent = app.started ? `Turn ${app.index+1}/${app.schedule.length}` : 'Round —';
  renderAll();
}

/* ===========
   Setup & Schedule
   =========== */

function buildSchedule(count, doubleRun){
  const pool = deepCopy(SCENARIOS);
  const selected = pool.slice(0, Math.min(count, pool.length));
  const schedule = [];
  if(doubleRun){
    selected.forEach(s=>{
      schedule.push({scenarioId:s.id, team:'A'});
      schedule.push({scenarioId:s.id, team:'B'});
    });
  } else {
    selected.forEach((s, idx)=>{
      schedule.push({scenarioId:s.id, team: (idx%2===0?'A':'B') });
    });
  }
  return schedule;
}

/* ===========
   Effects & Tokens
   =========== */

function applyEffects(teamKey, effects){
  const team = app.teams[teamKey];
  for(const k of Object.keys(effects||{})){
    team.meters[k] = clamp(team.meters[k] + effects[k], 0, 100);
  }
}

function awardTokensFromTags(teamKey, tags=[]){
  const team = app.teams[teamKey];
  let awarded = [];
  const t = team.tokens;
  if(tags.some(x=>['gratitude','savor'].includes(x))){ t.G = (t.G||0)+1; awarded.push('Gratitude +1'); }
  if(tags.some(x=>['exercise','mindful','optimism','coping'].includes(x))){ t.M = (t.M||0)+1; awarded.push('Mindful Pause +1'); }
  if(tags.some(x=>['relationships','kindness','family'].includes(x))){ t.S = (t.S||0)+1; awarded.push('Social Support (reroll)'); }
  renderMeters(teamKey);
  return awarded;
}

/* ===========
   Choice Handling (v1.1 aware)
   =========== */

function onChoiceSelected(scen, choice, teamKey, dyn){
  dyn = dyn || computeChoiceDynamics(choice, teamKey);

  if(choice.type==='safe' && dyn.status==='risk'){
    const riskChoice = riskifyChoice(choice, dyn.threshold);
    openChallengeModal(scen, riskChoice, teamKey, dyn.threshold, dyn);
    return;
  }

  if(choice.type==='challenge'){
    if(dyn.status==='locked'){ return; }
    if(dyn.status==='auto'){
      applyEffects(teamKey, choice.success);
      const awarded = awardTokensFromTags(teamKey, choice.tags);
      recordMoment(teamKey, scen, choice, dyn.threshold, null, true, choice.success, awarded, 'AUTO', dyn.mods, dyn.reason);
      nextTurn();
      return;
    }
    openChallengeModal(scen, choice, teamKey, dyn.threshold, dyn);
    return;
  }

  if(choice.type==='safe' && dyn.status==='normal'){
    applyEffects(teamKey, choice.effects);
    const awarded = awardTokensFromTags(teamKey, choice.tags);
    recordMoment(teamKey, scen, choice, null, null, null, choice.effects, awarded, null, dyn.mods, dyn.reason);
    nextTurn();
  }
}

/* ===========
   Challenge Modal (Dice)
   =========== */

const modal = byId('challengeModal');
let modalState = null;

function openChallengeModal(scen, choice, teamKey, overrideThreshold=null, dyn=null){
  modalState = {
    scen, choice, teamKey,
    threshold: clamp((overrideThreshold ?? (choice.difficulty + app.baseDiffOffset)), 2, 6),
    roll:null,
    used:{G:false, M:false, S:false},
    modifiedRoll:null,
    outcome:null,
    randomEvent:null,
    dyn: dyn || computeChoiceDynamics(choice, teamKey)
  };
  byId('challengeTitle').textContent = choice.label;
  byId('die').textContent = '—';
  byId('resultBox').textContent = '';
  const modsLine = (modalState.dyn && modalState.dyn.mods && modalState.dyn.mods.length)
    ? 'Difficulty mods: ' + modalState.dyn.mods.map(m => `${m.delta>0?'+':''}${m.delta} ${m.key} (${m.why})`).join(', ')
    : '';
  byId('randomEventBox').textContent = modsLine;
  byId('applyOutcomeBtn').disabled = true;

  byId('difficultyKbd').textContent = `${modalState.threshold}+`;

  ['G','M','S'].forEach(k=>{
    const btnId = k==='G'?'useG': (k==='M'?'useM':'useS');
    const btn = byId(btnId);
    const available = (app.teams[teamKey].tokens[k]||0) > 0;
    btn.disabled = !available;
    btn.classList.toggle('muted', !available);
  });

  modal.showModal();
}

byId('useG').addEventListener('click', (e)=>{
  if(!modalState) return;
  if(modalState.used.G) return;
  if((app.teams[modalState.teamKey].tokens.G||0)<=0) return;
  modalState.used.G = true;
  app.teams[modalState.teamKey].tokens.G--;
  byId('resultBox').innerHTML = `Gratitude boost used: +1 to your roll <span class="small muted">(and +Joy small)</span>`;
  applyEffects(modalState.teamKey, {joy:+3});
  renderMeters(modalState.teamKey);
  e.currentTarget.disabled = true;
});

byId('useM').addEventListener('click', (e)=>{
  if(!modalState) return;
  if(modalState.used.M) return;
  if((app.teams[modalState.teamKey].tokens.M||0)<=0) return;
  modalState.used.M = true;
  app.teams[modalState.teamKey].tokens.M--;
  byId('resultBox').innerHTML = `Mindful Pause boost used: +1 to your roll <span class="small muted">(and +Vitality small)</span>`;
  applyEffects(modalState.teamKey, {vitality:+3});
  renderMeters(modalState.teamKey);
  e.currentTarget.disabled = true;
});

byId('useS').addEventListener('click', (e)=>{
  if(!modalState) return;
  if(modalState.used.S) return;
  if((app.teams[modalState.teamKey].tokens.S||0)<=0) return;
  modalState.used.S = true; // consume only on reroll
  byId('resultBox').innerHTML = `Social Support armed: you may reroll once after seeing the first result. Press <span class="kbd">R</span> or click “Roll” again.`;
  e.currentTarget.disabled = true;
});

byId('rollBtn').addEventListener('click', ()=>doRoll(false));
document.addEventListener('keydown', (e)=>{
  if(e.key.toLowerCase()==='r' && modal.open && modalState && modalState.roll!==null && modalState.used.S){
    doRoll(true);
  }
});

function doRoll(isReroll=false){
  if(!modalState) return;
  const firstTime = modalState.roll===null;
  if(!firstTime && !modalState.used.S) return;
  if(!firstTime && modalState.used.S){
    const t = app.teams[modalState.teamKey].tokens;
    if((t.S||0)<=0) return;
    t.S--;
  }

  const r = randInt(1,6);
  modalState.roll = r;
  let modified = r + (modalState.used.G?1:0) + (modalState.used.M?1:0);
  modalState.modifiedRoll = Math.min(modified, 6);

  let eventMsg = '';
  let eventApplied = null;
  if(r===1){
    eventMsg = 'Random event: MTR delay — time/energy lost (Vitality −2).';
    eventApplied = {vitality:-2};
  } else if(r===6){
    eventMsg = 'Random event: Helpful alum appears — small boost (Connection +2).';
    eventApplied = {connection:+2};
  }
  if(eventApplied){ applyEffects(modalState.teamKey, eventApplied); }
  byId('randomEventBox').textContent = (byId('randomEventBox').textContent? byId('randomEventBox').textContent + ' · ' : '') + eventMsg;

  const success = modalState.modifiedRoll >= modalState.threshold;
  modalState.outcome = success ? 'success' : 'fail';

  const die = byId('die');
  die.textContent = '…';
  setTimeout(()=>{
    die.textContent = r;
    const msg = success
      ? `Success! Rolled ${modalState.modifiedRoll} (raw ${r}${modalState.used.G||modalState.used.M?` with boosts`:''}) ≥ ${modalState.threshold}.`
      : `Failed. Rolled ${modalState.modifiedRoll} (raw ${r}${modalState.used.G||modalState.used.M?` with boosts`:''}) < ${modalState.threshold}.`;
    byId('resultBox').innerHTML = success ? `<span class="success">${msg}</span>` : `<span class="fail">${msg}</span>`;
    byId('applyOutcomeBtn').disabled = false;
  }, 220);
}

byId('applyOutcomeBtn').addEventListener('click', ()=>{
  if(!modalState) return;
  const { scen, choice, teamKey, outcome } = modalState;
  const effects = outcome==='success' ? choice.success : choice.fail;
  applyEffects(teamKey, effects);
  const awarded = awardTokensFromTags(teamKey, choice.tags);
  const statusNote = modalState?.dyn?.status==='risk' ? 'RISK' : null;
  recordMoment(teamKey, scen, choice, modalState.threshold, modalState.modifiedRoll, outcome==='success', effects, awarded, statusNote, modalState?.dyn?.mods||[], modalState?.dyn?.reason||'');
  modal.close();
  modalState = null;
  nextTurn();
});
byId('cancelOutcomeBtn').addEventListener('click', ()=>{ modal.close(); modalState=null; });
byId('closeModal').addEventListener('click', ()=>{ modal.close(); modalState=null; });

/* ===========
   Recording & Debrief
   =========== */

function recordMoment(teamKey, scen, choice, threshold, roll, success, effects, tokensAwarded, statusNote=null, mods=[], reason=''){
  const team = app.teams[teamKey];
  const others = scen.choices.filter(c=>c.id!==choice.id).map(c=>({
    label:c.label,
    type:c.type,
    difficulty: c.type==='challenge' ? c.difficulty + app.baseDiffOffset : null,
    approx: c.approx
  }));
  team.history.push({
    scenarioId: scen.id,
    scenarioTitle: scen.title,
    prompt: scen.prompt,
    choiceLabel: choice.label,
    choiceType: choice.type,
    threshold, roll, success: success??null,
    effects, tokensAwarded,
    alternatives: others,
    key: scen.key,
    statusNote, mods, reason
  });
}

function teamScoreSummary(team){
  const vals = Object.values(team.meters);
  const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
  const minv = Math.min(...vals);
  const bonus = (minv>=35)? 5 : 0;
  return Math.round(avg + bonus);
}

function openDebrief(){
  const modal = byId('debriefModal');
  byId('debAName').textContent = app.teams.A.name + ` — Score ${teamScoreSummary(app.teams.A)}`;
  byId('debBName').textContent = app.teams.B.name + ` — Score ${teamScoreSummary(app.teams.B)}`;
  buildDebriefList('A','debA');
  buildDebriefList('B','debB');
  modal.showModal();
}

function buildDebriefList(teamKey, containerId){
  const team = app.teams[teamKey];
  const container = byId(containerId);
  container.innerHTML = '';
  const list = document.createElement('div'); list.className='list';
  const moments = team.history;

  if(moments.length===0){
    list.innerHTML = `<div class="small muted">No moments recorded.</div>`;
    container.appendChild(list);
    return;
  }

  const scored = moments.map(m=>{
    const mag = Object.values(m.effects||{}).reduce((a,b)=>a+Math.abs(b),0);
    return {...m, mag};
  }).sort((a,b)=>b.mag-a.mag);
  const top = scored.slice(0,Math.min(3,scored.length));

  moments.forEach(m=>{
    const div = document.createElement('div'); div.className='callout';
    const head = document.createElement('div');
    head.innerHTML = `<b>${m.scenarioTitle}</b> <span class="small muted">(${m.choiceType==='safe'?'SAFE':'CHALLENGE'})</span>`;
    const detail = document.createElement('div');
    const eff = Object.entries(m.effects||{}).map(([k,v])=>{
      const sign = v>=0?'+':'';
      return `<span class="small">${k[0].toUpperCase()+k.slice(1)} ${sign}${v}</span>`;
    }).join(' · ');
    const rollTxt = (m.choiceType==='challenge' && (m.roll!==null || m.threshold!==null))
      ? ` — ${m.statusNote==='AUTO'?'AUTO ✓':(m.roll!==null?`roll ${m.roll}${m.success? ' ✓':' ✕'} (needs ${m.threshold}+)`:`needs ${m.threshold}+`)}`
      : '';
    const star = top.find(t=>t.scenarioId===m.scenarioId && t.choiceLabel===m.choiceLabel)? ' ⭐' : '';
    const modsTxt = (m.mods && m.mods.length) ? `<div class="small muted">mods: ${m.mods.map(x=>(x.delta>0?'+':'')+x.delta+' '+x.key).join(', ')}</div>` : '';
    const statusTxt = m.statusNote && m.statusNote!=='AUTO' ? `<div class="small muted">${m.statusNote}${m.reason?`: ${m.reason}`:''}</div>` : '';

    detail.innerHTML = `<div><b>Choice:</b> ${m.choiceLabel}${star}${rollTxt}</div><div class="small muted">${m.prompt}</div><div class="small" style="margin-top:6px;"><b>Effect:</b> ${eff||'—'}</div>${modsTxt}${statusTxt}`;

    const alt = document.createElement('div'); alt.className='alt'; alt.innerHTML = `<div style="margin-top:6px;"><b>Alternatives to discuss:</b></div>`;
    const ul = document.createElement('ul'); ul.style.margin='6px 0 0 18px';
    m.alternatives.forEach(a=>{
      const li = document.createElement('li');
      li.innerHTML = `<span>${a.label}</span> <span class="small muted">— ${a.type==='challenge'?'needs '+a.difficulty+'+':''} ${a.approx?(' · '+a.approx):''}</span>`;
      ul.appendChild(li);
    });
    alt.appendChild(ul);

    div.append(head, detail, alt);
    list.appendChild(div);
  });

  container.appendChild(list);
}

/* ===========
   Turn Flow
   =========== */

function nextTurn(){
  app.index++;
  if(app.index >= app.schedule.length){
    renderAll();
    openDebrief();
    return;
  }
  renderScenarioCard();
}

function switchTeam(){
  app.activeTeam = app.activeTeam==='A'?'B':'A';
  renderAll();
}

/* ===========
   Setup & Controls
   =========== */

function startSession(){
  const aName = byId('teamAName').value.trim() || 'Team A';
  const bName = byId('teamBName').value.trim() || 'Team B';
  const count = parseInt(byId('scenarioCount').value,10) || 8;
  const diff = parseInt(byId('overallDifficulty').value,10) || 0;
  const doubleRun = byId('doubleRun').checked;

  app.teams.A.name = aName;
  app.teams.B.name = bName;
  app.teams.A.meters = {...BASE_START};
  app.teams.B.meters = {...BASE_START};
  app.teams.A.tokens = {G:1, M:1, S:1};
  app.teams.B.tokens = {G:1, M:1, S:1};
  app.teams.A.history = [];
  app.teams.B.history = [];

  app.baseDiffOffset = diff;
  app.doubleRun = doubleRun;
  app.schedule = buildSchedule(count, doubleRun);
  app.index = 0;
  app.started = true;
  app.activeTeam = app.schedule[0]?.team || 'A';

  byId('preGame').style.display = 'none';
  app.startTime = Date.now();
  if(app.timerInt) clearInterval(app.timerInt);
  app.timerInt = setInterval(()=>{
    const now = Date.now();
    byId('timer').textContent = formatMinSec(now - app.startTime);
  }, 1000);

  renderAll();
  renderScenarioCard();
}

/* ===========
   Debrief download/print
   =========== */
function escapeHtml(s){ return (s+'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

function teamScoreSummaryForDoc(team){
  const vals = METERS.map(m=>`${m.label}: ${Math.round(team.meters[m.key])}`).join(' · ');
  return vals;
}

function makeDebriefHTML(){
  function teamPanel(team){
    const vals = teamScoreSummaryForDoc(team);
    const h = team.history.map(m=>{
      const eff = Object.entries(m.effects||{}).map(([k,v])=>{
        const sign = v>=0?'+':'';
        return `${k}:${sign}${v}`;
      }).join(' ');
      const mods = (m.mods && m.mods.length) ? `\nMods: ${m.mods.map(x=>(x.delta>0?'+':'')+x.delta+' '+x.key).join(', ')}` : '';
      const note = m.statusNote ? `\nNote: ${m.statusNote}${m.reason?` — ${m.reason}`:''}` : '';
      const alts = m.alternatives.map(a=>`- ${a.label} ${a.type==='challenge'?`(needs ${a.difficulty}+)`:''} ${a.approx?`— ${a.approx}`:''}`).join('\n');
      return `• ${m.scenarioTitle} — ${m.choiceLabel}${m.choiceType==='challenge' && (m.roll!==null || m.threshold!==null) ? ` [${m.statusNote==='AUTO'?'AUTO ✓':(m.roll!==null?`roll ${m.roll}${m.success?' ✓':' ✕'}; needs ${m.threshold}+`:`needs ${m.threshold}+`)}]`:''}
   Effects: ${eff}${mods}${note}
   Alternatives:\n${alts}`;
    }).join('\n\n');
    return `<h2>${escapeHtml(team.name)} — Score ${teamScoreSummary(team)}</h2>
<p>${escapeHtml(vals)}</p>
<pre style="white-space:pre-wrap;font-size:12px;background:#0f1422;color:#eaf1ff;border:1px solid #25314e;padding:10px;border-radius:8px;">${escapeHtml(h)}</pre>`;
  }
  const html = `<!doctype html><meta charset="utf-8"><title>Pathways Debrief</title>
  <style>body{font-family:Arial,system-ui;background:#0b0f1a;color:#eaf1ff;padding:20px;line-height:1.45;}
  h1,h2{margin:0 0 10px 0;} .hr{height:1px;background:#23314f;margin:14px 0;} pre{border-radius:8px;}</style>
  <h1>Pathways — Debrief</h1>
  <p>Maslow foundations (Vitality, Security, Connection, Mastery, Purpose) plus Joy. Happiness habits: gratitude, kindness, relationships, savoring, flow, goals, optimism/coping, forgiveness/spirituality, body care. Readiness‑gated mechanics from v1.1.</p>
  <div class="hr"></div>
  ${teamPanel(app.teams.A)}
  <div class="hr"></div>
  ${teamPanel(app.teams.B)}
  <p style="font-size:12px;color:#a9b7d6;margin-top:16px;">Generated locally — share for class discussion.</p>`;
  return html;
}

/* ===========
   Event wiring
   =========== */

byId('startBtn').addEventListener('click', startSession);
byId('restartBtn').addEventListener('click', ()=>location.reload());
byId('switchBtn').addEventListener('click', switchTeam);

byId('downloadDebrief').addEventListener('click', ()=>{
  const html = makeDebriefHTML();
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'pathways-debrief.html';
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 100);
});
byId('printDebrief').addEventListener('click', ()=>window.print());
byId('closeDebrief').addEventListener('click', ()=>byId('debriefModal').close());

// Guide modal controls
const guideModal = byId('guideModal');
byId('openGuideBtn').addEventListener('click', ()=>guideModal.showModal());
byId('closeGuideBtn').addEventListener('click', ()=>guideModal.close());
document.addEventListener('keydown', (e)=>{ if(e.key==='?'){ guideModal.showModal(); }});

// Close debrief/guide with Esc
document.addEventListener('keydown', (e)=>{
  if(e.key==='Escape'){
    if(guideModal.open) guideModal.close();
    if(byId('debriefModal').open) byId('debriefModal').close();
    if(modal.open) modal.close();
  }
});

/* ===========
   Initial render
   =========== */
renderAll();
</script>
</body>
</html>
